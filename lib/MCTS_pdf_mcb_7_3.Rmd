---
output: pdf_document
fig_caption: true
params: 
    set_title: "My Title!"
---


---
title: `r "Microbiome Diet Study Participant Report"`
---


Thank you for participating in the Knights Lab citizen science project: The Microbiome Diet Study. Included in this report is some high-level information about your daily dietary intake and your daily microbiome variation. This report does not provide any medical advice and is not intended to be used to diagnose disease. If you have questions about your report, or you would like access to your raw data, please contact the study coordinator Abby Cole at cole0463@umn.edu


Your average daily nutritional intakes contrasted to recommended nutritional intake levels:


| Type                | Your Average                   | Study Average                          |Recommended Daily Allowances|
|---------------------|--------------------------------|----------------------------------------|----------------------------|  
| CALORIES (kcal)     | `r round(mean(submap$KCAL),2)` | `r round(mean(map$KCAL,na.rm=TRUE),2)` |
| PROTEIN (g)         | `r round(mean(submap$PROT),2)` | `r round(mean(map$PROT,na.rm=TRUE),2)` |
| TOTAL FAT (g)       | `r round(mean(submap$TFAT),2)` | `r round(mean(map$TFAT,na.rm=TRUE),2)` |
| CARBS (g)           | `r round(mean(submap$CARB),2)` | `r round(mean(map$CARB,na.rm=TRUE),2)` |
| FIBER (g)           | `r round(mean(submap$FIBE),2)` | `r round(mean(map$FIBE,na.rm=TRUE),2)` |
| FOLATE (mcg)        | `r round(mean(submap$FOLA),2)` | `r round(mean(map$FOLA,na.rm=TRUE),2)` |
| SELENIUM (mcg)      | `r round(mean(submap$SELE),2)` | `r round(mean(map$SELE,na.rm=TRUE),2)` |
| CALCIUM (mg)        | `r round(mean(submap$CALC),2)` | `r round(mean(map$CALC,na.rm=TRUE),2)` |
| POTASSIUM (mg)      | `r round(mean(submap$POTA),2)` | `r round(mean(map$POTA,na.rm=TRUE),2)` |
| MAGNESIUM (mg)      | `r round(mean(submap$MAGN),2)` | `r round(mean(map$MAGN,na.rm=TRUE),2)` |
| ZINC (mg)           | `r round(mean(submap$ZINC),2)` | `r round(mean(map$ZINC,na.rm=TRUE),2)` |
| VITAMIN A (mcg)     | `r round(mean(submap$VARA),2)` | `r round(mean(map$VARA,na.rm=TRUE),2)` |
| VITAMIN B6 (mg)     | `r round(mean(submap$VB6),2)`  | `r round(mean(map$VB6,na.rm=TRUE),2)`  | 
| VITAMIN B12 (mcg)   | `r round(mean(submap$VB12),2)` | `r round(mean(map$VB12,na.rm=TRUE),2)` |
| VITAMIN D (mcg)     | `r round(mean(submap$VITD),2)` | `r round(mean(map$VITD,na.rm=TRUE),2)` |
| VITAMIN E (mg)      | `r round(mean(submap$ATOC),2)` | `r round(mean(map$ATOC,na.rm=TRUE),2)` |
| VITAMIN K (mcg)     | `r round(mean(submap$VK),2)`   | `r round(mean(map$VK,na.rm=TRUE),2)`   |


The above table shows your average daily intake of key macro and micro nutrients during the study period. For your reference also shown here are the overall average for the other participants in the study and the recommended intake levels by gender. 

<!-- MicroNutrients -->

```{r, echo = F, warning=FALSE, message=FALSE,  fig.height=10, fig.width=10,fig.cap='Figure 1 visualizes day to day variation in your consumption of micronutrients viewed as a percentage of total kilocalorie intake. Protein intakes are abbreviated as "PROT", Carbohydrate intakes are abbreviated as "CARB", and Total Fat intakes are abbreviated as "TFAT" in the figure legend'}


long_plot <- submap %>% select(X.SampleID, KCAL, PROT, TFAT, CARB, UserName)
long_plot$PROT <- long_plot$PROT*4/long_plot$KCAL
long_plot$TFAT <- long_plot$TFAT*9/long_plot$KCAL
long_plot$CARB <- long_plot$CARB*4/long_plot$KCAL


long_plot <- melt(long_plot, id.vars = c("X.SampleID", "UserName", "KCAL"), 
                  measure.vars = c("PROT", "TFAT", "CARB"), 
                  variable.name = "Macro", value.name = "PCT")

colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)
tick_label <- seq(1:17)

# plot kcal filled with % protein, fat, and carb
ggplot(long_plot, aes(x = X.SampleID, y = KCAL*PCT, fill = Macro)) +
  geom_bar(stat = "identity") +
  facet_grid(.~UserName, scales = "free") +
  theme_classic() +
  scale_color_manual(values=colpal)+
  scale_fill_brewer(palette = "Set2") +
   scale_x_discrete(labels=c(tick_label))+
  labs(fill = "% Macronutrient", y = "Daily reported intake (Kcal)", x = "Study Day Number") +
  theme(
        axis.title.x =element_text(family = "Helvetica"), axis.title.y =element_text(family = "Helvetica"),
        plot.title = element_text(hjust = 0.5))+
ggtitle("Daily Micronutrient Consumption as a percentage of Kilocalorie Intake")

``` 

<!-- Daily Calorie Intake -->

```{r, warning=F, message=F, echo=FALSE, fig.cap='Figure 2 visualizes your Fiber intake on a day-to-day basis. Add blurb pertaining to microbiome importance'}

colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)
tick_label <- seq(1:17)

p <- ggplot(submap,aes(x = StudyDayNo,y = FIBE)) + 
  scale_color_manual(values=colpal)+
     geom_bar(aes(fill = StudyDayNo),stat = "identity",position = "dodge") + scale_x_discrete(labels = abbreviate)
p+guides(fill=FALSE) +
  theme_classic(base_family = "Helvetica")+
   theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=c(tick_label))+
  labs(x="Study Day Number", y= "Fiber levels in grams")+
  ggtitle("Daily Fiber Intake")
```

<!-- Microbiome Daily Relative Abundance -->

```{r, warning=F, message=F, echo=FALSE, fig.cap='Figure 3 depicts the most abundant bacterial species within your gut per each day of the study. The "<10% abundance" column represents a sum of bacterial species that individually account for less than 10% of'}
# make ggplot bar chart of top 10 most abundant species per day
#melt subtaxasp to get our dataframe in the long format for future usage
  meltdf<- melt(subtaxasp)
  
  #merge to get access to Day var
  mergedf<- merge(x=meltdf, y=map, by.x = "variable", by.y= "X.SampleID", all.x=TRUE)
  
  #convert our dataframe species (rn) column to a character
  mergedf$rn <- as.character(mergedf$rn) 
  
  #series of gsub commands meant to neaten and clarify legend content
  mergedf$rn <- gsub(".*s__", "", mergedf$rn)
  mergedf$rn <- gsub("\\[", "",mergedf$rn)
  mergedf$rn <- gsub("\\]", "",mergedf$rn)
  mergedf$rn <- gsub("_", " ",mergedf$rn)
  

  
  
  #create <10% abundance category
  mergedf$rn[mergedf$value < 0.07] <- "<7% abundance"
  
  colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)
  tick_label <- seq(1:17)

  
ggplot(mergedf, aes(x = StudyDayNo, y = value, fill = rn)) +
  geom_bar(stat = "identity") +
  scale_x_discrete(drop = FALSE,labels=c(tick_label)) +
  scale_color_manual(values=colpal)+
  theme_classic(base_family = "Helvetica") +
  theme(strip.text.y = element_text(angle = 0, size = 8, face = "italic", family = "Helvetica"),
        axis.text.x = element_text( hjust = 1, family = "Helvetica"),
        plot.title =  element_text(hjust = 0.5, family = "Helvetica"),
        strip.background = element_rect(color = "grey")) +
  guides(fill = guide_legend(reverse = TRUE, 
                             keywidth = 1, 
                             keyheight = 1, 
                             ncol = 1,
                             title= "Bacterial Species")) +
 labs(y="Relative Abundance",x="Study Day Number")+
  ggtitle("Main species within your gut per day")





```


<!--Subject Day-to-Day Variation in Alpha Diversity of the Microbiome-->


```{r, warning=F, message=F, echo=FALSE, fig.cap='Figure 4 details how the bacterial diversity exhibited within your gut changes on a daily basis. This diversity catalogued within the gut microbiome is known as alpha diversity, and the metric utilized is the Shannon index of alpha diversity. The Shannon index accounts for both abundance and eveness of bacterial species present within the gut microbiome. '}
 #transpose
   subtaxaalpha <- t(subtaxaalpha)
 
  #calculate alpha diversity and assign to variable alphad
   alphad <- diversity(subtaxaalpha, index = "shannon", MARGIN = 1, base = exp(1))
   alphad <- as.data.frame(alphad)
   alphad <- rownames_to_column(alphad, var = "X.SampleID")
   
   #merge melted df with map to get access to StudyDay variable
   merged_alpha<- merge(x=alphad, y=map, all.x=TRUE)
   
   colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)

#make gg plot line graph of subject alpha diversity per day
ggplot(merged_alpha, aes(x=StudyDayNo, y=alphad, group = UserName)) +
  geom_point() +
  theme_classic(base_family = "Helvetica") +
  theme(axis.title.x =element_text(family = "Helvetica"), axis.title.y =element_text(family = "Helvetica"),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  geom_smooth() +
  scale_color_manual(values=colpal)+
  labs(x= "Study Day Number",y="Alpha Diversity (Shannon)")+
  ggtitle(" Day-to-Day Variation in Alpha Diversity of the Gut Microbiome")
  
```


<!--Subject Day-To-Day Variation in Beta Diversity of the Microbiome-->

```{r,fig.width=10, fig.height=10, echo=FALSE, fig.cap='Figure 5 is a plot that represents how dissimilar certain individuals microbiomes are relative to each other. The shape corresponding to your (subject number) represents your microbiome - multiple of the same shapes correspond to each of the multiple days of testing.'}
#create PCOA plot of beta diversities of pertinent subjects
# 

betad<-vegdist(betataxa, method="bray", binary=FALSE, diag=FALSE, upper=FALSE,
        na.rm = FALSE) 

#betad as matrix 
betad <- as.matrix(dist(betad))

#column name is "IDs"
IDs <-colnames(betad)

# Run the pcoa() function on the beta diversity table, and store the vectors generated as a dataframe 
PCOA <- data.frame(pcoa(betad)$vectors)

#create vector with placeholders

new_names <- rep("",ncol(PCOA))

#create for loop which gives column names (currently named "axis") the name of PC1, PC2, PC3.. so forth
#Each column for the PCOA matrix is a new PC (number).

for(i in 1:ncol(PCOA)){
  new_names[i] <- paste("PC",i,sep="")  
}

#code above uses a for loop - from the range of 1 to the number of columns in the PCOA
#matrix, the for loop accesses the new name variable and names it PC + i (which is 1,2,3  depending on column
#as indicated by for loop - for loop increases in increments of 1 (i goes up by 1) and goes thru columns)

#new_names (PC1, PC2, etc..) replace the current colnames
names(PCOA) <- new_names

#creates column that is sampleID
PCOA$X.SampleID <- IDs


#merge map and PCOA by SampleID - select both lines and run together - won't work otherwise

PCOA <- merge(PCOA, map, by = 'X.SampleID')


PCOA <- merge(PCOA, map, by = 'UserName')


#### Plot PCOA ####


#instantiate shape and color palettes 

shape_pal <- c(1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8)
shape_pal2 <- c(1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3)
shape_pal3 <- c(15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18)
colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)
id <- gsub("_", " ",id)

#use ggplot to plot
ggplot(PCOA) +
  geom_point(aes(x=PC1,y=PC2, col=UserName, shape=UserName, size=4),alpha=.085) + #gives axes and item of focus
  labs(title=paste0(" Day-To-Day Variation in Beta Diversity of the Gut Microbiome - PCOA -  ", id) ) +
   guides( colour = guide_legend(override.aes = list(size=5,alpha=1))) +
  scale_shape_manual(values=shape_pal3) +
  scale_color_manual(values=colpal)+
  theme_classic(base_family = "Helvetica") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

 


  
```




