---
output: 
  pdf_document: 
    latex_engine: xelatex
mainfont: Calibri
fig_caption: true
params: 
    set_title: "My Title!"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

---
title: "Microbiome Diet Study Participant Report `r id`"
---


Thank you for participating in the Knights Lab's citizen science project. We are glad you were willing to take part in our Microbiome Diet Study!  

Included in this report is information about your daily dietary intake and your daily microbiome variation. This report does not provide any medical advice and is not intended to be used to diagnose or treat disease. If you have any questions about your report, or you would like access to your raw data, please contact the study coordinator Abby Johnson at cole0463@umn.edu


#Your Dietary Intake Data

This first table shows your average macronutrient intake as a percentage of calories and the typical macronutrient intake ranges for US adults:

&nbsp;


| Type                | Your Macronutrient Intake Proportions                     | Typical Intake Range        |
|---------------------|-----------------------------------------------------------|-----------------------------|
| CALORIES (kcal)     | `r round(mean(submap$KCAL),2)`                            |                             |
| PROTEIN (%)         | `r round((mean(submap$PROT)/macro_totals)*100,2)`%        |   10 - 35%                  | 
| TOTAL FAT (%)       | `r round((mean(submap$TFAT)/macro_totals)*100,2)`%        |   20 - 35%                  |  
| CARBS (%)           | `r round((mean(submap$CARB)/macro_totals)*100,2)`%        |   45 - 65%                  |                                      

Please note, it is common for people who follow some diets, like the low carbohydrate diet, to have intake ranges that differ from the typical intake ranges. As long as your diet is nutritionally adequate (see next table), it's usually OK if your intake ranges are different.

&nbsp;

\newpage
This second table shows your average daily intake of key micronutrients from food. Also shown are the average intake levels for all of our study participants and the recommended dietary allowance levels by gender. If you take a vitamin and mineral supplement, your intake from that supplement is not reflected here. For your reference, included here are the overall average intake levels of micronutrients for the other participants in the study and the recommended intake levels for each gender:


| Nutrient            | Your Average                   | Study Average                          |Recommended Dietary Allowance(Male/Female)|
|---------------------|--------------------------------|----------------------------------------|------------------------------------------|          
| FOLATE (mcg)        | `r round(mean(submap$FOLA),2)` | `r round(mean(map$FOLA,na.rm=TRUE),2)` |                 400                      |
| CHOLINE (mg)        | `r round(mean(submap$CHOLN),2)`| `r round(mean(map$CHOLN,na.rm=TRUE),2)`|                550 / 425                 |
| CALCIUM (mg)        | `r round(mean(submap$CALC),2)` | `r round(mean(map$CALC,na.rm=TRUE),2)` |                 1000 *                   |
| SODIUM (mg)         | `r round(mean(submap$SODI),2)` | `r round(mean(map$SODI,na.rm=TRUE),2)` |                 1500 *                   |
| POTASSIUM (mg)      | `r round(mean(submap$POTA),2)` | `r round(mean(map$POTA,na.rm=TRUE),2)` |                 4700                     | 
| MAGNESIUM (mg)      | `r round(mean(submap$MAGN),2)` | `r round(mean(map$MAGN,na.rm=TRUE),2)` |               400 / 310 *                | 
| IRON (mg)           | `r round(mean(submap$IRON),2)` | `r round(mean(map$IRON,na.rm=TRUE),2)` |                8 / 18  *                 |
| SELENIUM (mcg)      | `r round(mean(submap$SELE),2)` | `r round(mean(map$SELE,na.rm=TRUE),2)` |                 55                       |
| ZINC (mcg)          | `r round(mean(submap$ZINC),2)` | `r round(mean(map$ZINC,na.rm=TRUE),2)` |                11 / 8  *                 |
| VITAMIN B12 (mcg)   | `r round(mean(submap$VB12),2)` | `r round(mean(map$VB12,na.rm=TRUE),2)` |                 2.4                      |
| VITAMIN A (mcg)     | `r round(mean(submap$VARA),2)` | `r round(mean(map$VARA,na.rm=TRUE),2)` |               900 / 700                  |
| VITAMIN C (mg)      | `r round(mean(submap$VC),2)`   | `r round(mean(map$VC,na.rm=TRUE),2)`   |                90 / 75                   |
| VITAMIN D (mcg)     | `r round(mean(submap$VITD),2)` | `r round(mean(map$VITD,na.rm=TRUE),2)` |                 15 *                     |
| VITAMIN E (mg)      | `r round(mean(submap$ATOC),2)` | `r round(mean(map$ATOC,na.rm=TRUE),2)` |                 15                       |
| VITAMIN K (ug)      | `r round(mean(submap$VK),2)`   | `r round(mean(map$VK,na.rm=TRUE),2)`   |               120 / 90                   |


&nbsp;

Please note, values marked with asterisks are the recommended dietary allowance values for adults between 18 and 30 years old. These values are the daily intake level that is sufficient to meet the needs of 97-98% of the population. If you are older than 30, your recommended dietary allowance may be higher or lower than what's shown here. You can visit https://ods.od.nih.gov/Health_Information/Dietary_Reference_Intakes.aspx for a comphrenhensive breakdown of dietary reference intakes by age and gender.

If your intake of a vitamin or mineral falls below the recommended level for your gender you should consider increasing your intake of foods that contain are a good source of that vitamin or mineral. For example, the study average intake of vitamin D falls below the recommended level of 15 mcg. So many of the participants in our study could benefit by eating more vitmain D containing foods like fatty fish (such as salmon, tuna, and mackerel), fortified milk products, beef liver, egg yolks, and some mushrooms.


\newpage
##Figure 1:

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}


long_plot <- submap %>% select(X.SampleID, KCAL, PROT, TFAT, CARB, UserName)
long_plot$PROT <- long_plot$PROT*4/long_plot$KCAL
long_plot$TFAT <- long_plot$TFAT*9/long_plot$KCAL
long_plot$CARB <- long_plot$CARB*4/long_plot$KCAL


long_plot <- melt(long_plot, id.vars = c("X.SampleID", "UserName", "KCAL"), 
                  measure.vars = c("PROT", "TFAT", "CARB"), 
                  variable.name = "Macro", value.name = "PCT")


#instantiate color brewer and axis tick mark amount
colpal <- colorRampPalette(brewer.pal(9,"Set3"))(3)
colpal <- sample(colpal,3,replace = FALSE)
tick_label <- seq(1:17)

# plot kcal filled with % protein, fat, and carb
ggplot(long_plot, aes(x = X.SampleID, y = KCAL*PCT, fill = Macro)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  scale_fill_manual(values=colpal)+
  #scale_fill_brewer(palette = colpal) +
   scale_x_discrete(labels=c(tick_label))+
  labs(fill = "% Macronutrient", y = "Daily reported intake (Kcal)", x = "Study Day Number") +
  theme(
        #axis.title.x =element_text(family = "Helvetica"), axis.title.y =element_text(family = "Helvetica"),
        plot.title = element_text(hjust = 0.5))+
ggtitle("Daily macronutrient distributrion as percentage of calorie intake")

``` 

Figure 1 shows the day to day variation in your consumption of macronutrients viewed as a percentage of total kilocalorie intake. Protein intakes are abbreviated as "PROT", Carbohydrate intakes are abbreviated as "CARB", and Total Fat intakes are abbreviated as "TFAT" in the figure legend.





##Figure 2:
```{r, warning=FALSE, message=FALSE, echo=FALSE}

#instantiate color brewer and axis tick mark amounts
colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)
colpal<- sample(colpal,37, replace = FALSE)
tick_label <- seq(1:17) 

#Study average for individual's fiber intake
fiber_average <-round(mean(submap$FIBE),2)
fiber_rec <- round(14*mean(submap$KCAL)/1000)

p <- ggplot(submap,aes(x = StudyDayNo,y = FIBE)) + 
     geom_bar(aes(fill = colpal[1]),stat = "identity",position = "dodge") + scale_x_discrete(labels = abbreviate)+
      geom_hline(size=.75,col="red",yintercept = fiber_rec) + #Recommended fiber level
      geom_hline(size=.75,col="gold",yintercept = fiber_average)  #Recommended fiber level

p + guides(fill=F) +
  theme_classic(base_family = "Helvetica")+
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=c(tick_label))+
  scale_fill_manual(values = colpal)+
  labs(x="Study Day Number", y= "Fiber levels in grams")+
  ggtitle("Daily Fiber Intake")

```

Figure 2 shows your fiber intake each day throughout the study. You had an average fiber consumption of `r round(mean(submap$FIBE),2)` grams per day. The red line in this plot shows the recommended level of fiber consumption in grams, while the gold line shows your average daily fiber intake. The current recomendation for fiber intake is to consume 14g per 1000kcal. We have calculated your fiber needs from your average reported calorie intake throughout the study. 

Fiber is an important energy source for the bacteria that live within your microbiome. Meeting the recommended intake of fiber may help to support a healthy microbiome. If your average fiber intake falls below the recommended intake level, you should consider increasing your intake of fiber by eating more fibrous vegetables and increasing your intake of whole grains.


##Figure 3:
```{r, warning=FALSE, message=FALSE, echo=FALSE}

# make ggplot bar chart of top 10 most abundant species per day
#melt sub_foodsp to get our dataframe in the long format for future usage (differs from melted_food)
  melt_food<- melt(sub_foodsp)
  
  #merge to get access to Day var (differs from merged_food)
  merge_food<- merge(x=melt_food, y=map, by.x = "variable", by.y= "X.SampleID", all.x=TRUE)
  
  #rename columns to get rid of the .x following UserName and StudyDayNo
  
  colnames(merge_food)[4] <- "UserName" #Change col name from UserName.x to UserName - compatibility purposes
  colnames(merge_food)[5] <- "StudyDayNo" #Change col name from StudyDayNo.x to StudyDayNo - compatibility purposes
  
  #convert our dataframe species (rn) column to a character
  merge_food$rn <- as.character(merge_food$rn) 
  
  #series of gsub commands meant to neaten and clarify legend content
  merge_food$rn <- gsub(".*s__", "", merge_food$rn)
  merge_food$rn <- gsub("\\[", "",merge_food$rn)
  merge_food$rn <- gsub("\\]", "",merge_food$rn)
  merge_food$rn <- gsub("_", " ",merge_food$rn)
  merge_food$rn <- gsub("L1", "",merge_food$rn)
  
  
  #instantiate color brewer and axes tick mark amount
  colpal <- colorRampPalette(brewer.pal(8,"Set3"))
  colpal <- sample(colpal(length(unique(merge_food$rn))))
  tick_label <- seq(1:17)

  
ggplot(merge_food, aes(x = StudyDayNo, y = value, fill = rn)) +
  geom_bar(stat = "identity") +
  scale_x_discrete(drop = FALSE,labels=c(tick_label)) +
   scale_fill_manual(values =colpal)+
  theme_classic(base_family = "Helvetica") +
  theme(axis.text.x = element_text( hjust = 0.5, family = "Helvetica"),
        plot.title =  element_text(hjust = 0.5, family = "Helvetica"),
        strip.background = element_rect(color = "grey")) +
  guides(fill = guide_legend(reverse = FALSE, 
                             keywidth = 1, 
                             keyheight = 1, 
                             ncol = 1,
                             title= "Food Group")) +
 labs(y="Relative Abundance",x="Study Day Number")+
  ggtitle("Food groups consumed each day")

```

Figure 3 shows the relative abundance of the major food groups you consumed on a day to day basis during the study, excluding water. Each color is representative of a unique food group as annotated on the figure legend. Please note that these food groups are displayed by their weight, so the plot tends to over-represent the contribution of liquid foods and foods with high water content to your diet. You may notice that the largest food component each day is called "Sugars, sweets and beverages". For most participants in this study, the size of that bar is driven by intake of coffee and tea, not sugar and candy.


\newpage
#Your Microbiome Composition Data

The next series of plots show information about the composition of your microbiome.  

We sequenced the DNA of the microbes that live within your gut from the daily stool samples you provided. We used a type of sequencing called Shallow-shotgun sequencing coupled with programs developed in the Knights's lab to identify the species of bacteria that live inside you.


##Figure 4:
```{r, warning=FALSE, message=FALSE, echo=FALSE}
# make ggplot bar chart of top 10 most abundant species per day
  
#melt subtaxasp to get our dataframe in the long format for future usage
  
  meltdf<- melt(subtaxasp)
  
  #merge to get access to Day var
  mergedf<- merge(x=meltdf, y=map, by.x = "variable", by.y= "X.SampleID", all.x=TRUE)
  
  #convert our dataframe species (rn) column to a character
  mergedf$rn <- as.character(mergedf$rn) 
  
  #series of gsub commands meant to neaten and clarify legend content
  mergedf$rn <- gsub(".*s__", "", mergedf$rn)
  mergedf$rn <- gsub("\\[", "",mergedf$rn)
  mergedf$rn <- gsub("\\]", "",mergedf$rn)
  mergedf$rn <- gsub("_", " ",mergedf$rn)
  
  
  #create small abundance category
  mergedf$rn[mergedf$value < 0.025] <- "<2.5% abundance"
  mergedf <- mergedf %>% group_by(StudyDayNo, rn) %>% summarise(newvalue = sum(value))
  
  
  #instantiate color brewer and axes tick mark amount
  colpal<- colorRampPalette(brewer.pal(8,"Set3"))
  colpal<- sample(colpal(length(unique(mergedf$rn))))
  tick_label <- seq(1:17)

  
ggplot(mergedf, aes(x = StudyDayNo, y = newvalue, fill = rn)) +
  geom_bar(stat = "identity") +
  scale_x_discrete(drop = FALSE,labels=c(tick_label)) +
   scale_fill_manual(values =colpal)+
  theme_classic(base_family = "Helvetica") +
  theme(axis.text.x = element_text( hjust = 0.5, family = "Helvetica"),
        plot.title =  element_text(hjust = 0.5, family = "Helvetica"),
        strip.background = element_rect(color = "grey")) +
  guides(fill = guide_legend(reverse = FALSE, 
                             keywidth = 1, 
                             keyheight = 1, 
                             ncol = 1,
                             title= "Bacterial Species")) +
 labs(y="Relative Abundance",x="Study Day Number")+
  ggtitle("Bacterial species in your gut each day")


```

Figure 4 shows the most abundant bacterial species within your gut per each day of the study. The "<2.5% abundance" column represents a sum of bacterial species that individually account for less than 2.5% of the bacterial population within your gut microbiome. If you don't have data for 1 day it's either becuase you did not submit a sample for that day, your sample wasn't able to be sequenced, or we did not get enough sequence data from your sample to reliably use it for data analysis.



##Figure 5:
```{r, warning=FALSE, message=FALSE, echo=FALSE} 
 #transpose
   subtaxaalpha <- t(subtaxaalpha)
 
  #calculate alpha diversity and assign to variable alphad
   alphad <- diversity(subtaxaalpha, index = "shannon", MARGIN = 1, base = exp(1))
   alphad <- as.data.frame(alphad)
   alphad <- rownames_to_column(alphad, var = "X.SampleID")
   
   #merge melted df with map to get access to StudyDay variable
   merged_alpha<- merge(x=alphad, y=map, all.x=TRUE)
    tick_label <- seq(1:17)
   colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)

#make gg plot line graph of subject alpha diversity per day
ggplot(merged_alpha, aes(x=StudyDayNo, y=alphad, group = UserName)) +
  geom_point() +
  theme(
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  theme_classic()+
  geom_smooth(aes(fill=colpal[1])) +
  scale_x_discrete(drop = FALSE,labels=c(tick_label)) +
  labs(x= "Study Day Number",y="Alpha Diversity (Shannon)")+
  guides(fill=FALSE)+
  ggtitle("Alpha diversity of your gut microbiome")
  
```

Figure 5 shows how the bacterial diversity exhibited within your gut changes on a daily basis. The measure of diversity shown here is called the Shannon index of alpha diversity. The Shannon index accounts for both the abundance and eveness of bacterial species present within the gut microbiome. A higher Shannon index typically indicates a more diverse microbiome community.


##Figure 6:

```{r,fig.width=10, fig.height=10, echo=FALSE}
#create PCOA plot of beta diversities of pertinent subjects


betad<-vegdist(betataxa, method="bray", binary=FALSE, diag=FALSE, upper=FALSE,
        na.rm = FALSE) 

#betad as matrix 
betad <- as.matrix(dist(betad))

#column name is "IDs"
IDs <-colnames(betad)

# Run the pcoa() function on the beta diversity table, and store the vectors generated as a dataframe 
PCOA <- data.frame(pcoa(betad)$vectors)

#create vector with placeholders

new_names <- rep("",ncol(PCOA))

#create for loop which gives column names (currently named "axis") the name of PC1, PC2, PC3.. so forth
#Each column for the PCOA matrix is a new PC (number).

for(i in 1:ncol(PCOA)){
  new_names[i] <- paste("PC",i,sep="")  
}

#code above uses a for loop - from the range of 1 to the number of columns in the PCOA
#matrix, the for loop accesses the new name variable and names it PC + i (which is 1,2,3  depending on column
#as indicated by for loop - for loop increases in increments of 1 (i goes up by 1) and goes thru columns)

#new_names (PC1, PC2, etc..) replace the current colnames
names(PCOA) <- new_names

#creates column that is sampleID
PCOA$X.SampleID <- IDs


#merge map and PCOA by SampleID - select both lines and run together - won't work otherwise

PCOA <- merge(PCOA, map, by = 'X.SampleID')


PCOA <- merge(PCOA, map, by = 'UserName')


#### Plot PCOA ####


#instantiate shape and color palettes 

shape_pal <- c(1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8)
shape_pal2 <- c(1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3,1,2,3)
shape_pal3 <- c(15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18,15,19,17,18)
colpal<- colorRampPalette(brewer.pal(9,"Set3"))(37)
id <- gsub("_", " ",id)

# PCOA[PCOA$UserName %in% id,]


#dt[dt$fct %in% vc,]
#PCOA1<- PCOA[PCOA$UserName %in% id,]

#dubloon %>% filter(value==TRUE) 

#filter(PCOA, UserName %in% id)

#use ggplot to plot
ggplot(PCOA) +
  geom_point(aes(x=PC1,y=PC2, col=UserName, shape=UserName,
                 size=ifelse(PCOA$UserName %in% id == TRUE,15,5)),
             alpha=.060, 
             stroke=3) + #gives axes and item of focus
  #stat_ellipse(alpha = 0.3, geom="polygon", linetype=2, aes(x = PC1, y = PC2, fill = PCOA$UserName %in% id))+
  labs(title=paste0("Beta diversity of your gut microbiome - PCOA -  ", id) ) +
  guides(colour = guide_legend(override.aes = list(size=5,alpha=1))) +
  scale_shape_manual(values=shape_pal3) +
  scale_color_manual(values=colpal)+
  theme_classic(base_family = "Helvetica") +                                                                      
  theme(legend.position = "bottom", 
        plot.title = element_text(size = 18, hjust = 0.5))

 


  
```
Figure 6 is a PCoA plot. A PCoA plot summarizes variability within a given dataset by producing a set of uncorrelated axes. Essentially, the PCoA plot can be utilized to interpret similarity of data points -- data points closer to one another are more similar to one another, while points further away from eachother are more dissimilar. Each data point in this plot represents a unique sample collected by a study participant. Samples from the same study participant are the same color and shape. The shape correspinding to your subject ID, `r id`, represents data points pertaining to your gut microbiome and has been enlarged to help you find yourself on this plot in comparison to the other study participants. When viewing this plot, keep in mind that it is a 2-dimensional representation of a 3-dimensional plot. So if your points look like they are all in the same place, they might actually extend into or out of the page! 

